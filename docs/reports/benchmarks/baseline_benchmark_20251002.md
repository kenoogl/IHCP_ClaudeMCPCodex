# ベースライン性能測定結果（改訂版）

## 測定概要

**測定日時**: 2025年10月2日
**Julia バージョン**: 1.11.7
**スレッド数**: 1（シングルスレッド）
**BLASスレッド数**: 1（**逐次実行**）
**測定目的**: Phase 1.1 並列化導入前のベースライン性能取得

## 測定環境

- **OS**: macOS (Darwin 24.6.0)
- **CPU**: Apple Silicon (詳細不明、推定M系)
- **メモリ**: 不明
- **Julia**: 1.11.7
- **最適化**: なし（デフォルト、逐次実行）

## 測定項目

**Large問題サイズ（80×100×20、N=160,000格子点）** での個別関数ベンチマーク:

1. **build_dhcp_system!**: DHCP係数構築
2. **assemble_dhcp_matrix**: DHCP疎行列組み立て
3. **solve_dhcp!**: DHCP単一ステップ求解
4. **build_adjoint_system!**: Adjoint係数構築
5. **solve_adjoint!**: Adjoint単一ステップ求解

## ベンチマーク結果（Large問題: 80×100×20）

### 1. DHCP係数構築 (`build_dhcp_system!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.003246 秒 (3.2 ms) |
| 中央値 | 0.003566 秒 (3.6 ms) |
| 平均値 | 0.003728 秒 (3.7 ms) |
| 最大時間 | 0.006425 秒 (6.4 ms) |
| サンプル数 | 100 |
| **スループット** | **4.49e+07 格子点/秒** |

**分析**:
- Large問題では3.6ミリ秒（Small問題の11 μsから325倍増加）
- 格子点数が160倍増加に対して時間は325倍 → メモリアクセスの影響
- **並列化の対象として適切な粒度**

### 2. DHCP疎行列組み立て (`assemble_dhcp_matrix`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.009880 秒 (9.9 ms) |
| 中央値 | 0.011603 秒 (11.6 ms) |
| 平均値 | 0.014903 秒 (14.9 ms) |
| 最大時間 | 0.063028 秒 (63.0 ms) |
| サンプル数 | 100 |

**分析**:
- 係数構築の約3.3倍の時間
- COO→CSC変換が主要コスト
- 最大時間のばらつきが大きい（GC影響）

### 3. DHCP単一ステップ求解 (`solve_dhcp!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.319879 秒 (320 ms) |
| 中央値 | 0.324853 秒 (325 ms) |
| 平均値 | 0.336665 秒 (337 ms) |
| 最大時間 | 0.374376 秒 (374 ms) |
| サンプル数 | 50 |

**分析**:
- 約325ミリ秒/ステップ（Large問題）
- Small問題（964 μs）の337倍
- CG法求解が支配的（〜310 ms）

### 4. Adjoint係数構築 (`build_adjoint_system!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.003431 秒 (3.4 ms) |
| 中央値 | 0.003746 秒 (3.7 ms) |
| 平均値 | 0.003957 秒 (4.0 ms) |
| 最大時間 | 0.006272 秒 (6.3 ms) |
| サンプル数 | 100 |
| **スループット** | **4.27e+07 格子点/秒** |

**分析**:
- DHCP係数構築と同等の性能（3.7 ms）
- **並列化の対象として適切**

### 5. Adjoint単一ステップ求解 (`solve_adjoint!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.067896 秒 (68 ms) |
| 中央値 | 0.070252 秒 (70 ms) |
| 平均値 | 0.078084 秒 (78 ms) |
| 最大時間 | 0.115832 秒 (116 ms) |
| サンプル数 | 50 |

**分析**:
- DHCP求解の約1/5の時間（70 ms vs 325 ms）
- 後退時間積分のため反復回数が少ない

## 性能サマリー

### Large問題（80×100×20、N=160,000）での内訳

| 処理 | 時間（中央値） | 割合 |
|-----|-------------|-----|
| DHCP係数構築 | 3.6 ms | 1.1% |
| DHCP疎行列組み立て | 11.6 ms | 3.6% |
| DHCP CG求解 | ~310 ms | 95.3% |
| **DHCP合計（1ステップ）** | **325 ms** | **100%** |

### Adjoint問題での内訳

| 処理 | 時間（中央値） | 割合 |
|-----|-------------|-----|
| Adjoint係数構築 | 3.7 ms | 5.3% |
| Adjoint疎行列組み立て | （未測定、DHCP同等と仮定: 11.6 ms） | 16.5% |
| Adjoint CG求解 | ~55 ms | 78.2% |
| **Adjoint合計（1ステップ）** | **70 ms** | **100%** |

## 並列化効果の予測（Large問題）

### Phase 1.1 並列化導入の効果

**対象関数**: `build_dhcp_system!`, `build_adjoint_system!`

**現状の割合（DHCP 1ステップ）**:
- 係数構築: 3.6 ms / 325 ms = **1.1%**

**並列化後の予測（8コア並列、理想的な場合）**:
- 係数構築: 3.6 ms → 0.45 ms（8倍高速化）
- DHCP 1ステップ: 325 ms → 322 ms
- **改善率: 1.0%（単一ステップあたり3 ms削減）**

### 完全一致検証（357ステップ）での予測

**現状の実測値**:
- DHCP検証時間: 337秒
- 1ステップあたり: 337秒 / 357ステップ = 0.944秒/ステップ

**ベンチマーク結果との比較**:
- ベンチマーク: 325 ms/ステップ
- 実測: 944 ms/ステップ
- **差: 619 ms/ステップ（熱物性値計算、検証処理等のオーバーヘッド）**

**並列化後の予測（係数構築のみ並列化、8コア）**:
- 係数構築削減: 3.6 ms → 0.45 ms（3.15 ms削減/ステップ）
- 357ステップ総計: 3.15 ms × 357 = **1.12秒削減**
- 337秒 → 335.9秒
- **改善率: 0.3%（非常に限定的）**

**重要な発見**:
- **Large問題でも係数構築は1.1%のみ**
- CG求解が95.3%を占める
- **係数構築の並列化だけでは全体への影響は小さい**

### より効果的な最適化候補

**Phase 2.2 CG法改良（ILU前処理）**:
- CG反復回数を50%削減できれば: 310 ms → 155 ms
- DHCP 1ステップ: 325 ms → 170 ms
- **改善率: 47.7%**
- 357ステップ総計: (325 - 170) × 357 = **55秒削減**

**Phase 2.4 メモリプール**:
- GCオーバーヘッド削減: 15-25%改善
- 337秒 → 253-286秒
- **改善率: 15-25%**

## 結論と推奨事項

### 測定結果のまとめ

1. **係数構築の割合**: Large問題でも1.1%のみ（予想外に小さい）
2. **CG求解が支配的**: 95.3%を占める
3. **並列化の効果は限定的**: 係数構築のみの並列化では0.3%改善

### 推奨される戦略

**短期（Phase 1）**:
1. ~~係数構築の並列化~~ → **効果が限定的** （0.3%改善）
2. **CG法の最適化を優先**（Phase 2.2、ILU前処理） → 47.7%改善の可能性

**中期（Phase 2）**:
1. ILU前処理導入（Phase 2.2） - 最優先
2. メモリプール導入（Phase 2.4）
3. 外挿ホットスタート（Phase 2.3）

**長期（Phase 3）**:
1. GPU対応（CG求解全体の高速化）

### Phase 1.1 並列化について

**実施すべきか？**

**メリット**:
- 実装が簡単（1-2日）
- 数値精度への影響なし
- コードの並列化の知見獲得

**デメリット**:
- 効果が限定的（0.3%改善、1.1秒削減/357ステップ）
- より効果的な最適化（ILU前処理）に時間を使うべき

**判断**:
- **並列化は実施するが、優先度を下げる**
- **Phase 2.2（ILU前処理）を優先的に実装すべき**

## 次のステップ

### 優先順位付け（効果順）

| 改善項目 | 期待効果 | 実装難易度 | 優先度 |
|---------|---------|----------|-------|
| **Phase 2.2 ILU前処理** | 47.7% (55秒) | ★★★☆☆ | **最優先** |
| Phase 2.4 メモリプール | 15-25% (50-84秒) | ★★★★☆ | 高 |
| Phase 2.3 外挿ホットスタート | 10-15% (34-50秒) | ★★☆☆☆ | 中 |
| Phase 1.1 並列化導入 | 0.3% (1.1秒) | ★☆☆☆☆ | 低 |

## 参考情報

### 完全一致検証での性能（既知データ）

| 項目 | 値 |
|-----|-----|
| Julia版総実行時間 | 1516秒 |
| CGM計算時間 | 1179秒（77.8%） |
| DHCP検証時間 | 337秒（22.2%） |
| Python版総実行時間 | 106秒 |
| **Python版との差**: | **14.3倍遅い** |

**目標**: Phase 2完了時点で400-500秒（Python版の4-5倍）

## 測定ログ

```
============================================================
ベースライン性能測定（逐次実行）
============================================================
測定日時: 2025-10-02T20:22:24.973
Julia バージョン: 1.11.7
スレッド数: 1
BLASスレッド数: 1 [逐次実行]
============================================================

測定する問題サイズ:
  1. Small  (10×10×10)
  2. Medium (40×50×15)
  3. Large  (80×100×20, 完全一致検証サイズ) [推奨]
  4. すべて

選択 [1-4, デフォルト: 3]: [Enter]

============================================================
問題サイズ: large
============================================================
格子点数: 80×100×20 (N=160000)

[1/6] DHCP係数構築ベンチマーク
  測定中: build_dhcp_system! (ni=80, nj=100, nk=20, N=160000)...
  結果: build_dhcp_system!
    最小時間: 0.003246 秒
    中央値:   0.003566 秒
    平均値:   0.003728 秒
    最大時間: 0.006425 秒
    サンプル数: 100
    スループット: 4.49e+07 格子点/秒

[2/6] DHCP疎行列組み立てベンチマーク
  測定中: assemble_dhcp_matrix (N=160000)...
  結果: assemble_dhcp_matrix
    最小時間: 0.009880 秒
    中央値:   0.011603 秒
    平均値:   0.014903 秒
    最大時間: 0.063028 秒
    サンプル数: 100

[3/6] DHCP単一ステップベンチマーク
  測定中: solve_dhcp! (単一ステップ, N=160000)...
  結果: solve_dhcp! (1ステップ)
    最小時間: 0.319879 秒
    中央値:   0.324853 秒
    平均値:   0.336665 秒
    最大時間: 0.374376 秒
    サンプル数: 50

[4/6] Adjoint係数構築ベンチマーク
  測定中: build_adjoint_system! (ni=80, nj=100, nk=20, N=160000)...
  結果: build_adjoint_system!
    最小時間: 0.003431 秒
    中央値:   0.003746 秒
    平均値:   0.003957 秒
    最大時間: 0.006272 秒
    サンプル数: 100
    スループット: 4.27e+07 格子点/秒

[5/6] Adjoint単一ステップベンチマーク
  測定中: solve_adjoint! (単一ステップ, N=160000)...
  結果: solve_adjoint! (1ステップ)
    最小時間: 0.067896 秒
    中央値:   0.070252 秒
    平均値:   0.078084 秒
    最大時間: 0.115832 秒
    サンプル数: 50
```

---

**報告者**: Claude Code
**報告日**: 2025年10月2日
**改訂**: Large問題（完全一致検証サイズ）、BLAS逐次実行での再測定
