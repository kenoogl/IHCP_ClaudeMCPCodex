# ベースライン性能測定結果

## 測定概要

**測定日時**: 2025年10月2日
**Julia バージョン**: 1.11.7
**スレッド数**: 1（シングルスレッド）
**BLASスレッド数**: 4
**測定目的**: Phase 1.1 並列化導入前のベースライン性能取得

## 測定環境

- **OS**: macOS (Darwin 24.6.0)
- **CPU**: Apple Silicon (詳細不明、推定M系)
- **メモリ**: 不明
- **Julia**: 1.11.7
- **最適化**: なし（デフォルト）

## 測定項目

Small問題サイズ（10×10×10、N=1000格子点）での個別関数ベンチマーク:

1. **build_dhcp_system!**: DHCP係数構築
2. **assemble_dhcp_matrix**: DHCP疎行列組み立て
3. **solve_dhcp!**: DHCP単一ステップ求解
4. **build_adjoint_system!**: Adjoint係数構築
5. **solve_adjoint!**: Adjoint単一ステップ求解

## ベンチマーク結果（Small問題: 10×10×10）

### 1. DHCP係数構築 (`build_dhcp_system!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.000010 秒 (10 μs) |
| 中央値 | 0.000011 秒 (11 μs) |
| 平均値 | 0.000011 秒 (11 μs) |
| 最大時間 | 0.000016 秒 (16 μs) |
| サンプル数 | 100 |
| **スループット** | **8.92e+07 格子点/秒** |

**分析**:
- 非常に高速（11 μs）
- Small問題では並列化のオーバーヘッドが支配的になる可能性

### 2. DHCP疎行列組み立て (`assemble_dhcp_matrix`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.000050 秒 (50 μs) |
| 中央値 | 0.000066 秒 (66 μs) |
| 平均値 | 0.000076 秒 (76 μs) |
| 最大時間 | 0.001167 秒 (1167 μs) |
| サンプル数 | 100 |

**分析**:
- 係数構築の約6倍の時間
- COO→CSC変換が主要コスト
- 最大時間のばらつきが大きい（GC影響？）

### 3. DHCP単一ステップ求解 (`solve_dhcp!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.000914 秒 (914 μs) |
| 中央値 | 0.000964 秒 (964 μs) |
| 平均値 | 0.000959 秒 (959 μs) |
| 最大時間 | 0.001006 秒 (1006 μs) |
| サンプル数 | 50 |

**分析**:
- 約1ミリ秒/ステップ（Small問題）
- CG法求解が支配的
- 係数構築（11 μs）+ 疎行列組み立て（66 μs）+ CG求解（〜880 μs）

### 4. Adjoint係数構築 (`build_adjoint_system!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.000011 秒 (11 μs) |
| 中央値 | 0.000012 秒 (12 μs) |
| 平均値 | 0.000013 秒 (13 μs) |
| 最大時間 | 0.000018 秒 (18 μs) |
| サンプル数 | 100 |
| **スループット** | **8.25e+07 格子点/秒** |

**分析**:
- DHCP係数構築と同等の性能
- 並列化の効果が期待できる

### 5. Adjoint単一ステップ求解 (`solve_adjoint!`)

| 指標 | 値 |
|-----|-----|
| 最小時間 | 0.000312 秒 (312 μs) |
| 中央値 | 0.000326 秒 (326 μs) |
| 平均値 | 0.000329 秒 (329 μs) |
| 最大時間 | 0.000378 秒 (378 μs) |
| サンプル数 | 50 |

**分析**:
- DHCP求解の約1/3の時間
- 後退時間積分のため反復回数が少ない？

## 性能サマリー

### Small問題（10×10×10、N=1000）での内訳

| 処理 | 時間（中央値） | 割合 |
|-----|-------------|-----|
| DHCP係数構築 | 11 μs | 1.1% |
| DHCP疎行列組み立て | 66 μs | 6.8% |
| DHCP CG求解 | 〜880 μs | 91.3% |
| **DHCP合計（1ステップ）** | **964 μs** | **100%** |

### Adjoint問題での内訳

| 処理 | 時間（中央値） | 割合 |
|-----|-------------|-----|
| Adjoint係数構築 | 12 μs | 3.7% |
| Adjoint疎行列組み立て | （未測定、DHCP同等と仮定: 66 μs） | 20.2% |
| Adjoint CG求解 | 〜250 μs | 76.1% |
| **Adjoint合計（1ステップ）** | **326 μs** | **100%** |

## 並列化効果の予測

### Phase 1.1 並列化導入の効果

**対象関数**: `build_dhcp_system!`, `build_adjoint_system!`

**現状の割合（DHCP 1ステップ）**:
- 係数構築: 11 μs / 964 μs = **1.1%**

**並列化後の予測（8コア並列、理想的な場合）**:
- 係数構築: 11 μs → 1.4 μs（8倍高速化）
- DHCP 1ステップ: 964 μs → 954.4 μs
- **改善率**: (964 - 954.4) / 964 = **1.0%**

**結論**:
- **Small問題（N=1000）では並列化の効果は限定的（約1%）**
- CG求解が支配的（91.3%）のため、係数構築の高速化だけでは全体への影響は小さい
- **Large問題（N=160,000）では並列化の効果が大きくなると予測**

### Large問題での予測

**格子点数**: 80×100×20 = 160,000格子点（Small問題の160倍）

**係数構築の時間（線形スケーリング仮定）**:
- Small: 11 μs × 160 = 1,760 μs = **1.76 ミリ秒**
- Large（並列化後、8コア）: 1.76 ms / 8 = **0.22 ミリ秒**

**全体実行時間への影響**:
- Large問題では係数構築の割合が増加すると予測
- 完全一致検証（356ステップ、Large問題相当）でのDHCP時間: 337秒
- 1ステップあたり: 337秒 / 356ステップ = **0.947秒/ステップ**
- 係数構築が仮に5%を占める場合: 0.947秒 × 0.05 = 47.4 ミリ秒
- 並列化後: 47.4 ms / 8 = 5.9 ms
- **改善: 41.5 ミリ秒/ステップ → 総計約15秒（356ステップ）**

**改善率（Large問題、係数構築が5%の場合）**:
- 337秒 → 322秒（15秒削減）
- **改善率: 4.5%**

**注**: 実際のLarge問題での係数構築の割合を測定する必要がある

## 次のステップ

### 推奨アクション

1. **Large問題でのベンチマーク実施** (優先度: 高)
   - 80×100×20格子、357ステップでの詳細プロファイリング
   - 係数構築の実際の割合を測定
   - 並列化の期待効果を正確に算出

2. **Phase 1.1 並列化導入** (優先度: 高)
   - `build_dhcp_system!`の並列化
   - `build_adjoint_system!`の並列化
   - Large問題での効果測定

3. **CG法の最適化検討** (優先度: 中)
   - Small問題でCG求解が91.3%を占める
   - ILU前処理の導入（Phase 2.2）
   - 外挿ホットスタート（Phase 2.3）

## 参考情報

### 完全一致検証での性能（既知データ）

| 項目 | 値 |
|-----|-----|
| Julia版総実行時間 | 1516秒 |
| CGM計算時間 | 1179秒（77.8%） |
| DHCP検証時間 | 337秒（22.2%） |
| Python版総実行時間 | 106秒 |
| **Python版との差**: | **14.3倍遅い** |

**目標**: Phase 1-2完了時点で400-500秒（Python版の4-5倍）

## 測定ログ

```
============================================================
ベースライン性能測定
============================================================
測定日時: 2025-10-02T20:09:18.071
Julia バージョン: 1.11.7
スレッド数: 1
BLASスレッド数: 4
============================================================

測定する問題サイズ:
  1. Small  (10×10×10)
  2. Medium (40×50×15)
  3. Large  (80×100×20, 完全一致検証サイズ)
  4. すべて

選択 [1-4, デフォルト: 1]: 1

============================================================
問題サイズ: small
============================================================
格子点数: 10×10×10 (N=1000)

[1/6] DHCP係数構築ベンチマーク
  測定中: build_dhcp_system! (ni=10, nj=10, nk=10, N=1000)...
  結果: build_dhcp_system!
    最小時間: 0.000010 秒
    中央値:   0.000011 秒
    平均値:   0.000011 秒
    最大時間: 0.000016 秒
    サンプル数: 100
    スループット: 8.92e+07 格子点/秒

[2/6] DHCP疎行列組み立てベンチマーク
  測定中: assemble_dhcp_matrix (N=1000)...
  結果: assemble_dhcp_matrix
    最小時間: 0.000050 秒
    中央値:   0.000066 秒
    平均値:   0.000076 秒
    最大時間: 0.001167 秒
    サンプル数: 100

[3/6] DHCP単一ステップベンチマーク
  測定中: solve_dhcp! (単一ステップ, N=1000)...
  結果: solve_dhcp! (1ステップ)
    最小時間: 0.000914 秒
    中央値:   0.000964 秒
    平均値:   0.000959 秒
    最大時間: 0.001006 秒
    サンプル数: 50

[4/6] Adjoint係数構築ベンチマーク
  測定中: build_adjoint_system! (ni=10, nj=10, nk=10, N=1000)...
  結果: build_adjoint_system!
    最小時間: 0.000011 秒
    中央値:   0.000012 秒
    平均値:   0.000013 秒
    最大時間: 0.000018 秒
    サンプル数: 100
    スループット: 8.25e+07 格子点/秒

[5/6] Adjoint単一ステップベンチマーク
  測定中: solve_adjoint! (単一ステップ, N=1000)...
  結果: solve_adjoint! (1ステップ)
    最小時間: 0.000312 秒
    中央値:   0.000326 秒
    平均値:   0.000329 秒
    最大時間: 0.000378 秒
    サンプル数: 50
```

---

**報告者**: Claude Code
**報告日**: 2025年10月2日
