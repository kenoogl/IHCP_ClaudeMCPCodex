# Pythonコード構造分析レポート

**対象ファイル**: `/Users/Daily/Development/IHCP/TrialClaudeMCPCodex/python/original/IHCP_CGM_Sliding_Window_Calculation_ver2.py`
**解析日時**: 2025-09-30
**総行数**: 1701行
**ファイルサイズ**: 約64KB

---

## 1. 全関数リスト

| 関数名 | 開始行 | Numba | 主要目的 |
|--------|--------|-------|----------|
| `polyval_numba()` | 56 | @njit | 3次多項式の値計算（高速化版） |
| `thermal_properties_calculator()` | 64 | @njit(parallel=True) | 温度依存の比熱・熱伝導率計算（並列化） |
| `check_field_finite()` | 87 | @njit | フィールドの有限性検証（NaN/Inf検出） |
| `check_temperature_range()` | 107 | @njit | 温度場の物理的妥当性検証（150-3000K） |
| `check_flux_range()` | 141 | @njit | 熱流束の範囲検証（最大1e7 W/m²） |
| `check_gradient_magnitude()` | 174 | @njit | 空間勾配の大きさチェック（数値安定性） |
| `detect_numerical_anomalies()` | 253 | - | 数値異常の包括的検出システム |
| `handle_numerical_anomaly()` | 334 | - | 異常検出時の警告表示・対応提案 |
| `check_temperature_field()` | 375 | - | 温度場の総合検証ラッパー |
| `check_flux_field()` | 406 | - | 熱流束場の総合検証ラッパー |
| `check_adjoint_field()` | 437 | - | 随伴場の総合検証ラッパー |
| `handle_critical_anomaly()` | 470 | - | 重大異常の緊急対応（計算停止判定） |
| `enhanced_anomaly_response()` | 520 | - | 拡張異常対応（重大度分類・自動停止） |
| `get_memory_info()` | 608 | - | システムメモリ情報取得（psutil使用） |
| `safe_file_size_check()` | 640 | - | ファイルサイズ安全性チェック（GB単位） |
| `monitor_memory_usage()` | 664 | - | メモリ使用量監視・警告システム |
| `safe_load_large_data()` | 709 | - | 大容量データ安全読込（1.1GB対応） |
| `optimize_memory_usage()` | 792 | - | ガベージコレクション実行・メモリ最適化 |
| `memory_warning_system()` | 824 | - | メモリ使用量警告・自動GC |
| `check_memory_critical()` | 853 | - | 重大メモリ不足の緊急対応 |
| `check_diffusion_stability()` | 894 | - | 拡散数による数値安定性解析 |
| `extract_sorted_mat_files()` | 1000 | - | MATLABファイル抽出・番号順ソート |
| `load_region_temperature()` | 1015 | - | 指定領域の温度データ読込（MAT形式） |
| `coeffs_and_rhs_building_DHCP()` | 1086 | @njit(parallel=True) | 直接問題の係数行列・右辺構築（並列） |
| `assemble_A_DHCP()` | 1131 | - | 直接問題の疎行列組立（CSR形式） |
| `multiple_time_step_solver_DHCP()` | 1156 | - | 直接問題の多時間ステップソルバー（CG法） |
| `coeffs_and_rhs_building_Adjoint()` | 1227 | @njit(parallel=True) | 随伴問題の係数行列・右辺構築（並列） |
| `assemble_A_Adjoint()` | 1272 | - | 随伴問題の疎行列組立（CSR形式） |
| `multiple_time_step_solver_Adjoint()` | 1297 | - | 随伴問題の後退時間ソルバー（CG法） |
| `global_CGM_time()` | 1371 | - | コンジュゲートグラディエント法本体 |
| `sliding_window_CGM_q_saving()` | 1556 | - | スライディングウィンドウ計算・結果保存 |
| `main()` | 1642 | - | メイン実行関数（計算フロー統合） |

**Numba最適化関数**: 7個（全関数の約22%）
**数値異常検出関数**: 8個
**メモリ管理関数**: 7個
**コアソルバー関数**: 8個

---

## 2. 主要データ構造

### 2.1 計算グリッド
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `nz` | 20 | z方向（深さ方向）の格子数 |
| `dx` | 0.12e-3 m | x方向格子間隔（0.12 mm） |
| `dy` | 0.12e-3 * sin(80°)/sin(45°) m | y方向格子間隔（IRカメラ角度補正） |
| `Lz` | 0.5e-3 m | 試験片厚さ（0.5 mm） |
| `stretch_factor` | 3 | z方向格子の伸長係数（表面集中） |

**z方向格子**: 指数関数的に伸長した非均等格子（表面側に密集）

### 2.2 配列形状とデータ型
```python
T_measure_K      : (nt, ni, nj)         - 測定温度データ [K] (float64, 1.1GB)
T0               : (ni, nj, nk)         - 初期3D温度場 [K] (float64)
Y_obs            : (nt, ni, nj)         - 観測温度（表面） [K] (float64)
q                : (nt-1, ni, nj)       - 表面熱流束 [W/m²] (float64)
lambda_field     : (nt, ni, nj, nk)     - 随伴場（CGM用） (float64)
T_all            : (nt, ni, nj, nk)     - 全時間ステップ温度場 (float64)
cp, k            : (ni, nj, nk)         - 比熱・熱伝導率場 (float64)
```

**主要インデックス規則**:
- `i`: y方向物理（行方向）
- `j`: x方向物理（列方向）
- `k_ijk`: z方向（深さ方向、0=底面、nk-1=表面）
- `t`: 時間ステップ（0=初期、nt-1=最終）

### 2.3 境界条件
- **表面（k=nk-1）**: 熱流束境界条件 `q_surface[i,j]`（CGMで逆解析対象）
- **底面（k=0）**: 測定温度境界条件 `Y_obs[t,i,j]`（IRカメラデータ）
- **側面（i=0/ni-1, j=0/nj-1）**: 断熱境界条件（係数をゼロに設定）

---

## 3. 外部依存関係

### 3.1 インポートライブラリ
| ライブラリ | 用途 |
|-----------|------|
| `numpy` | 多次元配列計算・線形代数 |
| `pandas` | CSVデータ読込（熱物性値） |
| `numba` | JITコンパイル・並列化（@njit, prange） |
| `scipy.io.loadmat` | MATLABファイル読込（IRカメラデータ） |
| `scipy.sparse` | 疎行列（CSR形式）・CG法ソルバー |
| `scipy.sparse.linalg` | LinearOperator、共役勾配法（cg） |
| `psutil` | メモリ使用量監視 |
| `gc` | ガベージコレクション制御 |
| `warnings` | 警告表示 |
| `re` | 正規表現（ファイル名解析） |
| `os`, `pathlib.Path` | ファイルパス操作 |
| `time` | 計算時間計測 |
| `math.sin`, `radians` | 三角関数（格子補正） |

### 3.2 データファイル
| ファイル | サイズ | 用途 |
|---------|--------|------|
| `metal_thermal_properties.csv` | 小 | SUS304熱物性値（温度依存） |
| `T_measure_700um_1ms.npy` | 1.1GB | IRカメラ測定温度データ（時系列） |
| `SUS*.MAT` | 可変 | MATLABフォーマット生温度データ |

**データ配置**: `BASE_DIR = Path(__file__).resolve().parent`（スクリプト同階層）

---

## 4. コードアーキテクチャ詳細

### 4.1 熱物性値計算システム（行38-81）
```
CSV読込 → 3次多項式フィッティング → 温度場入力 → 比熱・熱伝導率場出力
       (polyfit)              (thermal_properties_calculator)
```
- **密度**: 温度依存性あるが定数近似（225℃での値使用）
- **比熱・熱伝導率**: 3次多項式で補間（Numba並列計算）

### 4.2 数値異常検出システム（行83-603）
**3層アーキテクチャ**:
1. **低レベル検証** (@njit高速化)
   - `check_field_finite()`: NaN/Inf検出
   - `check_temperature_range()`: 物理範囲検証
   - `check_gradient_magnitude()`: 勾配暴走検出

2. **統合検出**
   - `detect_numerical_anomalies()`: 異常タイプ分類・診断

3. **対応システム**
   - `handle_numerical_anomaly()`: 警告表示・推奨対応
   - `enhanced_anomaly_response()`: 重大度分類・自動停止判定

**異常検出閾値**:
- 温度範囲: 150K～3000K（SUS304融点考慮）
- 熱流束: 最大絶対値 1e7 W/m²
- 温度勾配: 最大 5000 K/m
- 熱流束勾配: 最大 1e8 W/m³

### 4.3 メモリ管理システム（行605-891）
**3段階監視**:
1. **警告レベル**: 6.0GB（ガベージコレクション自動実行）
2. **危険レベル**: 8.0GB（計算停止勧告）
3. **緊急停止**: 自動停止またはユーザー判断

**大容量データ読込戦略**:
```
ファイルサイズチェック → メモリ可用性検証 → 自動GC → データ読込 → 事後確認
      (2GB制限)        (必要量×1.5倍)      (gc.collect)   (np.load)
```

### 4.4 数値安定性解析（行894-992）
**拡散数チェック**:
```
D_max = k_max / (ρ_min × cp_min)
拡散数 = D_max × dt / dz²
推奨上限: 0.5（暗示的スキームでも）
```
警告時には安全な時間刻み `dt_safe` を自動計算・提案。

### 4.5 直接問題ソルバー（DHCP、行1079-1219）
**有限体積法（FVM）+ 完全陰的時間積分**:
```
係数構築(Numba並列) → CSR疎行列組立 → 前処理CG法 → 時間前進
  (7点ステンシル)      (diags)        (対角前処理)
```
- **前処理**: 対角スケーリング（inv_diag）
- **収束判定**: rtol=1e-6、maxiter=20000
- **ホットスタート**: 前時間ステップ解を初期値に使用

### 4.6 随伴問題ソルバー（Adjoint、行1221-1364）
**後退時間積分（時間反転）**:
```
T_cal(DHCP結果) + Y_obs(測定) → 随伴方程式構築 → 時間後退ソルバー
                              (底面残差注入)    (t=nt-1→0)
```
- **初期条件**: `λ(t=nt-1) = 0`
- **残差項**: 底面（k=0）で `2*(T_cal - Y_obs)` を注入
- **収束判定**: rtol=1e-8（DHCPより厳しい）

### 4.7 共役勾配法（CGM、行1366-1553）
**フロー**:
```
1. 直接問題 → T_cal
2. 停止判定 → Discrepancy原理 + プラトー検出
3. 随伴問題 → λ_field
4. 勾配計算 → grad = λ[:,:,表面]
5. 探索方向 → p_n（ポラック・リビエール公式 + リセット）
6. 感度問題 → dT（熱流束摂動に対する温度応答）
7. ステップサイズ → β = (r·Sp)/(Sp·Sp)
8. 更新 → q ← q - β*p_n
```

**停止条件（統合版）**:
- **Discrepancy**: `J < ε` かつ `max|ΔT| ≤ σ`
- **プラトー**: 直近P=10ステップの平均相対下降 < η=1e-4

**安定化技術**:
- 探索方向リセット（5反復ごと）
- ステップサイズクリッピング（1e8上限、初回のみ）
- 下降性保証（`grad·p_n > 0` チェック）

### 4.8 スライディングウィンドウ（行1556-1626）
```
ウィンドウ1: [0, L] → q1
            ↓（オーバーラップ）
ウィンドウ2: [L-o, 2L-o] → q2（前窓の末尾o点を初期値）
            ↓（平均化）
結合: q1[:-o] + 0.5*(q1[-o:]+q2[:o]) + q2[o:]
```
- **ウィンドウサイズ**: 可変（デフォルト未指定）
- **オーバーラップ**: 可変（重複部分は平均化）
- **初期値継承**: 前窓の最終時間領域を次窓の初期推定に使用

---

## 5. 計算フロー概要

```
main() 開始
  ├─ メモリ監視開始
  ├─ safe_load_large_data()        ← T_measure_700um_1ms.npy (1.1GB)
  ├─ 初期化
  │   ├─ T0 = T_measure[0] を3D拡張
  │   ├─ Y_obs = T_measure[:500]（時間制限）
  │   └─ q_init = zeros
  ├─ check_diffusion_stability()   ← 数値安定性解析
  ├─ global_CGM_time()            ← CGMループ
  │   ├─ [反復ループ it=0..max]
  │   │   ├─ multiple_time_step_solver_DHCP()
  │   │   │   └─ [時間ループ t=1..nt-1] → T_all
  │   │   ├─ 停止判定（Discrepancy + プラトー）
  │   │   ├─ multiple_time_step_solver_Adjoint()
  │   │   │   └─ [後退時間 t=nt-2..0] → λ_field
  │   │   ├─ 勾配計算 grad = λ[:,:,表面]
  │   │   ├─ 探索方向 p_n（CG公式）
  │   │   ├─ 感度問題 dT = DHCP(p_n)
  │   │   ├─ ステップサイズ β計算
  │   │   ├─ 更新 q ← q - β*p_n
  │   │   └─ 異常検出（温度・流束・随伴場・勾配）
  │   └─ return q, T_cal[-1], J_hist
  └─ 計算時間表示
```

---

## 6. 性能最適化技術

### 6.1 Numba JIT最適化
- **並列化対象**: `thermal_properties_calculator`（3重ループ）、`coeffs_and_rhs_building_DHCP/Adjoint`（全格子点ループ）
- **fastmath=False**: 数値精度優先（逆問題の性質上）
- **prange**: マルチコア並列実行（OpenMP風）

### 6.2 疎行列技術
- **CSR形式**: 7点ステンシル（3D）の効率的表現
- **対角前処理**: 条件数改善（収束高速化）
- **ホットスタート**: 時間積分での初期値再利用

### 6.3 メモリ最適化
- **遅延配列作成**: `np.empty_like`（初期化スキップ）
- **インプレース操作**: `x.ravel(order="F").copy()`（Fortran順序）
- **自動GC**: メモリ警告時の強制ガベージコレクション

---

## 7. 計算規模見積もり

### 7.1 メモリ使用量
**例**: ni=10, nj=10, nk=20, nt=500の場合
```
T_all:        500×10×10×20×8B = 8.0MB
lambda_field: 500×10×10×20×8B = 8.0MB
q:            499×10×10×8B    = 0.4MB
A_csr（係数行列）: 2000×7×8B  ≈ 0.1MB
-------------------------------------------
合計（計算バッファ含む）: 約20-30MB
```

**実データ**: T_measure_700um_1ms.npy = 1.1GB → ni×nj ≈ 100×100規模推定

### 7.2 計算複雑度
| 処理 | 複雑度 | 支配項 |
|------|--------|--------|
| 係数構築（Numba） | O(N) = O(ni×nj×nk) | 全格子点並列 |
| CG法1回 | O(nnz×iter) ≈ O(7N×iter) | 疎行列ベクトル積 |
| 直接問題1ステップ | O(N×iter_CG) | CG反復 |
| 随伴問題1ステップ | O(N×iter_CG) | CG反復 |
| CGM1反復 | O(nt×N×iter_CG) | 2回の多時間ステップソルバー |

**実用計算時間**: 単一ウィンドウ（nt=500）で数分～数十分（ハード依存）

---

## 8. 改善推奨事項

### 8.1 高優先度
1. **並列化拡張**:
   - 時間ループの並列化（複数GPUまたはMPI）
   - 疎行列ソルバーのGPU化（CuPy、cuSPARSE）

2. **メモリ効率化**:
   - `T_all`、`lambda_field`のチャンク化（全時間保存不要）
   - CSR行列の再利用（熱物性値変化小の場合）

3. **収束高速化**:
   - AMG前処理器（対角スケーリングより強力）
   - LBFGS法（Hessian近似による2次収束）

### 8.2 中優先度
4. **プラトー検出の洗練**:
   - 勾配ノルム `||grad||` の減衰率も併用
   - L-curve法による正則化パラメータ推定

5. **異常対応の自動化**:
   - ステップサイズの適応的調整（Armijo条件）
   - 重大異常時の自動セーブポイント作成

6. **ロギング強化**:
   - 構造化ログ出力（JSON形式）
   - 可視化用データエクスポート（収束履歴・異常統計）

### 8.3 低優先度
7. **コード分割**:
   - 関数群をモジュール化（dhcp_solver.py、adjoint_solver.py等）
   - 設定パラメータの外部ファイル化（YAML/TOML）

8. **テストコード追加**:
   - 熱物性値計算の単体テスト
   - 既知解問題での検証（製作解との比較）

---

## 9. まとめ

### 9.1 コードの特徴
- **堅牢性重視**: 数値異常検出とメモリ監視の多層防御
- **高度な数値技術**: FVM + 完全陰的法 + CGM + スライディングウィンドウ
- **性能最適化**: Numba JIT並列化と疎行列技術の効果的活用
- **大規模対応**: 1.1GBデータの安全読込機構

### 9.2 課題
- **モノリシック構造**: 1700行単一ファイル（モジュール分割推奨）
- **GPU未対応**: NumbaのCUDA機能未使用
- **メモリボトルネック**: 全時間ステップ保存による制約

### 9.3 性能評価
- **適用規模**: 中規模問題（100×100×20格子、500時間ステップ）まで実用的
- **計算時間**: CGM1反復あたり数秒～数十秒（ハード依存）
- **メモリ要件**: 実データで8GB以上推奨（監視閾値から逆算）

---

**レポート終了**
*本分析は10,000トークン以内でコードの構造的理解を提供します。詳細な実装コードの引用は最小限に抑えました。*